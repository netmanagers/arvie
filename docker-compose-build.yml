# According to arvbox, instances are
# api keep-web workbench2 controller keepstore0 keepstore1 workbench sso websockets arv-git-httpd keepproxy composer docker crunch-dispatch

version: '3'

services:
  ### ARVADOS-SERVER
  arvados-server:
    image: arvados/server
    build:
      context: .
      dockerfile: Dockerfile.goapp
      args:
        APP_DIR: cmd
        APP_NAME: arvados-server
  ### ARVADOS-CLIENT
  arvados-client:
    image: arvados/client
    build:
      context: .
      dockerfile: Dockerfile.goapp
      args:
        APP_DIR: cmd
        APP_NAME: arvados-client
  ### API
  # The API image can be build and run standalone as a rails app, 
  api:
    image: arvados/api
    build:
      context: .
      dockerfile: Dockerfile.rails
      args:
        APP_DIR: services
        APP_NAME: api
        PORT: 8004
        GEM_HOME: /cache/gem
        NPM_CONFIG_PREFIX: /cache/npm
        PIPCACHE: /cache/pip
  ### WORKBENCH
  workbench:
    image: arvados/workbench
    build:
      context: .
      dockerfile: Dockerfile.rails
      args:
        APP_DIR: apps
        APP_NAME: workbench
        PORT: 9002
        GEM_HOME: /cache/gem
        NPM_CONFIG_PREFIX: /cache/npm
        PIPCACHE: /cache/pip
  ### GIT-HTTPD
  git-httpd:
    image: arvados/git-httpd
    build:
      context: .
      dockerfile: Dockerfile.goapp
      args:
        APP_DIR: services
        APP_NAME: arv-git-httpd
  crunch-dispatch-local:
    # FIXME! Not sure if it needs a whole dockerd or a docker client
    # https://stackoverflow.com/questions/27879713/is-it-ok-to-run-docker-from-inside-docker
    image: arvados/crunch-dispatch-local
    build:
      context: .
      dockerfile: Dockerfile.goapp.crunch-dispatch-local
      args:
        APP_DIR: services
        APP_NAME: crunch-dispatch-local
  # crunch-dispatch-slurm:
  # crunch-run:
  # crunchstat:
  # dockercleaner:
  # fuse:
  health:
    image: arvados/health
    build:
      context: .
      dockerfile: Dockerfile.goapp
      args:
        APP_DIR: services
        APP_NAME: health
  keep-balance:
    image: arvados/keep-balance
    build:
      context: .
      dockerfile: Dockerfile.goapp
      args:
        APP_DIR: services
        APP_NAME: keep-balance
  keepproxy:
    image: arvados/keepproxy
    build:
      context: .
      dockerfile: Dockerfile.goapp
      args:
        APP_DIR: services
        APP_NAME: keepproxy
  keep-web:
    image: arvados/keep-web
    build:
      context: .
      dockerfile: Dockerfile.goapp
      args:
        APP_DIR: services
        APP_NAME: keep-web
  keepstore:
    image: arvados/keepstore
    build:
      context: .
      dockerfile: Dockerfile.goapp
      args:
        APP_DIR: services
        APP_NAME: keepstore
